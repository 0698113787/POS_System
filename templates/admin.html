<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Zakes Shisanyama</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="brand">
                <svg class="flame-icon" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                    <path d="M25 5 C20 15, 17.5 20, 17.5 27.5 C17.5 35, 20 40, 25 42.5 C30 40, 32.5 35, 32.5 27.5 C32.5 20, 30 15, 25 5 Z" 
                          fill="#FF6B35" stroke="#FF4500" stroke-width="1"/>
                    <path d="M25 10 C22.5 17.5, 21 21, 21 26 C21 31, 22.5 34, 25 36 C27.5 34, 29 31, 29 26 C29 21, 27.5 17.5, 25 10 Z" 
                          fill="#FFD700"/>
                </svg>
                <div>
                    <h1>ZAKES SHISANYAMA</h1>
                    <span class="role-badge admin">Admin Dashboard</span>
                </div>
            </div>
            <div class="user-info">
                <div class="user-details">
                    <span class="user-icon">üë®‚Äçüíº</span>
                    <div>
                        <div class="user-name">{{ session.username }}</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
                <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="/reports/daily" class="action-btn daily">
                <i class="fas fa-calendar-day"></i>
                <span>Daily Report</span>
            </a>
            <a href="/reports/monthly" class="action-btn monthly">
                <i class="fas fa-calendar-alt"></i>
                <span>Monthly Report</span>
            </a>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card revenue">
                <div class="stat-icon">
                    <svg viewBox="0 0 50 50">
                        <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="3"/>
                        <text x="25" y="32" text-anchor="middle" font-size="20" fill="currentColor" font-weight="bold">R</text>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="totalRevenue">R0.00</div>
                </div>
            </div>

            <div class="stat-card orders">
                <div class="stat-icon">
                    <svg viewBox="0 0 50 50">
                        <rect x="10" y="15" width="30" height="25" rx="2" fill="none" stroke="currentColor" stroke-width="3"/>
                        <path d="M15 15 L15 10 L35 10 L35 15" fill="none" stroke="currentColor" stroke-width="3"/>
                        <circle cx="20" cy="27" r="2" fill="currentColor"/>
                        <circle cx="25" cy="27" r="2" fill="currentColor"/>
                        <circle cx="30" cy="27" r="2" fill="currentColor"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total Orders</div>
                    <div class="stat-value" id="totalOrders">0</div>
                </div>
            </div>

            <div class="stat-card completed">
                <div class="stat-icon">
                    <svg viewBox="0 0 50 50">
                        <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="3"/>
                        <path d="M15 25 L22 32 L35 19" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value" id="completedOrders">0</div>
                </div>
            </div>

            <div class="stat-card pending">
                <div class="stat-icon">
                    <svg viewBox="0 0 50 50">
                        <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="3"/>
                        <path d="M25 15 L25 25 L32 32" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Pending</div>
                    <div class="stat-value" id="pendingOrders">0</div>
                </div>
            </div>
        </div>

        <!-- Revenue Cards -->
        <div class="revenue-cards">
            <div class="section-card daily">
                <div class="card-header">
                    <h2>üìä Today's Performance</h2>
                    <div class="header-decoration"></div>
                </div>
                <div class="revenue-display">
                    <div class="revenue-item">
                        <div class="revenue-icon">üí∞</div>
                        <div class="revenue-info">
                            <span class="revenue-label">Today's Revenue</span>
                            <span class="revenue-amount" id="dailyRevenue">R0.00</span>
                        </div>
                    </div>
                    <div class="revenue-item">
                        <div class="revenue-icon">üì¶</div>
                        <div class="revenue-info">
                            <span class="revenue-label">Today's Orders</span>
                            <span class="revenue-amount" id="dailyOrders">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-card monthly">
                <div class="card-header">
                    <h2>üìÖ Monthly Overview</h2>
                    <div class="header-decoration"></div>
                </div>
                <div class="revenue-display">
                    <div class="revenue-item">
                        <div class="revenue-icon">üíµ</div>
                        <div class="revenue-info">
                            <span class="revenue-label">This Month</span>
                            <span class="revenue-amount" id="monthlyRevenue">R0.00</span>
                        </div>
                    </div>
                    <div class="revenue-item">
                        <div class="revenue-icon">üìà</div>
                        <div class="revenue-info">
                            <span class="revenue-label">Orders Count</span>
                            <span class="revenue-amount" id="monthlyOrders">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <!-- Revenue Line Chart -->
            <div class="chart-card">
                <div class="card-header">
                    <h2>üìà Revenue Trend (Last 30 Days)</h2>
                    <div class="header-decoration"></div>
                </div>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- Orders Bar Chart -->
            <div class="chart-card">
                <div class="card-header">
                    <h2>üìä Daily Orders (Last 7 Days)</h2>
                    <div class="header-decoration"></div>
                </div>
                <div class="chart-container">
                    <canvas id="ordersChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Category and Popular Items -->
        <div class="two-column">
            <!-- Category Performance Chart -->
            <div class="chart-card">
                <div class="card-header">
                    <h2>üçñ Sales by Category</h2>
                    <div class="header-decoration"></div>
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- Popular Items -->
            <div class="section-card">
                <div class="card-header">
                    <h2>üî• Top Selling Items</h2>
                    <div class="header-decoration"></div>
                </div>
                <div class="popular-items" id="popularItems">
                    <div class="no-data">
                        <p>No data available</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Orders -->
        <div class="section-card">
            <div class="card-header">
                <h2>üïí Recent Orders</h2>
                <div class="header-decoration"></div>
            </div>
            <div class="recent-orders" id="recentOrders">
                <div class="no-data">
                    <p>No recent orders</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stats = {};
        let revenueChart, ordersChart, categoryChart;

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                stats = await response.json();
                displayStats();
                await loadCharts();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function displayStats() {
            // Overall stats
            document.getElementById('totalRevenue').textContent = `R${stats.totalRevenue?.toFixed(2) || '0.00'}`;
            document.getElementById('totalOrders').textContent = stats.totalOrders || 0;
            document.getElementById('completedOrders').textContent = stats.completedOrders || 0;
            document.getElementById('pendingOrders').textContent = stats.pendingOrders || 0;

            // Calculate daily revenue
            const today = new Date().toDateString();
            const dailyOrders = (stats.recentOrders || []).filter(order => {
                const orderDate = new Date(order.timestamp).toDateString();
                return orderDate === today;
            });
            
            const dailyRevenue = dailyOrders.reduce((sum, order) => sum + order.total, 0);
            document.getElementById('dailyRevenue').textContent = `R${dailyRevenue.toFixed(2)}`;
            document.getElementById('dailyOrders').textContent = dailyOrders.length;

            // Calculate monthly revenue
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyOrders = (stats.recentOrders || []).filter(order => {
                const orderDate = new Date(order.timestamp);
                return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
            });
            
            const monthlyRevenue = monthlyOrders.reduce((sum, order) => sum + order.total, 0);
            document.getElementById('monthlyRevenue').textContent = `R${monthlyRevenue.toFixed(2)}`;
            document.getElementById('monthlyOrders').textContent = monthlyOrders.length;

            // Popular items
            const popularItemsDiv = document.getElementById('popularItems');
            if (stats.popularItems && stats.popularItems.length > 0) {
                popularItemsDiv.innerHTML = stats.popularItems.map((item, index) => `
                    <div class="popular-item">
                        <div class="item-rank">${index + 1}</div>
                        <div class="item-details">
                            <div class="item-name">${item[0]}</div>
                            <div class="item-count">${item[1]} orders</div>
                        </div>
                        <div class="item-bar">
                            <div class="item-bar-fill" style="width: ${(item[1] / stats.popularItems[0][1]) * 100}%"></div>
                        </div>
                    </div>
                `).join('');
            } else {
                popularItemsDiv.innerHTML = '<div class="no-data"><p>No data available</p></div>';
            }

            // Recent orders
            const recentOrdersDiv = document.getElementById('recentOrders');
            if (stats.recentOrders && stats.recentOrders.length > 0) {
                recentOrdersDiv.innerHTML = stats.recentOrders.map(order => `
                    <div class="recent-order">
                        <div class="order-info">
                            <div class="order-id">Order #${order.id}</div>
                            <div class="order-customer">üë§ ${order.customerName}</div>
                        </div>
                        <div class="order-details">
                            <div class="order-time">${new Date(order.timestamp).toLocaleString()}</div>
                            <div class="order-total">R${order.total.toFixed(2)}</div>
                        </div>
                        <div class="order-status ${order.status}">
                            ${order.status === 'ready' ? '‚úì Ready' : '‚è≥ Pending'}
                        </div>
                    </div>
                `).join('');
            } else {
                recentOrdersDiv.innerHTML = '<div class="no-data"><p>No recent orders</p></div>';
            }
        }

        async function loadCharts() {
            await loadRevenueChart();
            await loadOrdersChart();
            await loadCategoryChart();
        }

        async function loadRevenueChart() {
            try {
                const response = await fetch('/api/analytics/chart-data');
                const data = await response.json();

                const ctx = document.getElementById('revenueChart').getContext('2d');
                
                if (revenueChart) {
                    revenueChart.destroy();
                }

                revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates || [],
                        datasets: [{
                            label: 'Revenue (R)',
                            data: data.revenues || [],
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading revenue chart:', error);
            }
        }

        async function loadOrdersChart() {
            try {
                const response = await fetch('/api/analytics/chart-data');
                const data = await response.json();

                const ctx = document.getElementById('ordersChart').getContext('2d');
                
                if (ordersChart) {
                    ordersChart.destroy();
                }

                ordersChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.dates?.slice(-7) || [],
                        datasets: [{
                            label: 'Number of Orders',
                            data: data.orderCounts?.slice(-7) || [],
                            backgroundColor: '#2196F3',
                            borderColor: '#1976D2',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading orders chart:', error);
            }
        }

        async function loadCategoryChart() {
            try {
                const response = await fetch('/api/analytics/category-performance');
                const data = await response.json();

                const ctx = document.getElementById('categoryChart').getContext('2d');
                
                if (categoryChart) {
                    categoryChart.destroy();
                }

                categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(cat => cat.category),
                        datasets: [{
                            data: data.map(cat => cat.total_sales),
                            backgroundColor: [
                                '#FF6B35',
                                '#4CAF50',
                                '#2196F3'
                            ],
                            borderWidth: 3,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading category chart:', error);
            }
        }

        // Auto-refresh stats every 30 seconds
        setInterval(loadStats, 30000);
        
        // Initial load
        loadStats();
    </script>
</body>
</html>