<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Report - Zakes Shisanyama</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='monthly.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="brand">
                <i class="fas fa-fire-flame-curved flame-icon"></i>
                <div>
                    <h1>ZAKES SHISANYAMA</h1>
                    <span class="role-badge">Monthly Report</span>
                </div>
            </div>
            <div class="user-info">
                <div class="user-details">
                    <i class="fas fa-user-shield user-icon"></i>
                    <div>
                        <div class="user-name">{{ session.username }}</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
                <a href="{{ url_for('dashboard') }}" class="back-btn">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
                <a href="{{ url_for('logout') }}" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Month Selector -->
        <div class="month-selector">
            <h2><i class="fas fa-calendar-alt"></i> Select Month & Year</h2>
            <input type="month" id="monthInput" value="">
            <button onclick="loadMonthlyReport()" class="load-btn">
                <i class="fas fa-sync-alt"></i> Load Report
            </button>
        </div>

        <!-- Summary Cards -->
        <div class="summary-grid">
            <div class="summary-card revenue">
                <div class="card-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="card-content">
                    <div class="card-label">Total Revenue</div>
                    <div class="card-value" id="totalRevenue">R0.00</div>
                    <div class="card-trend" id="revenueTrend"></div>
                </div>
            </div>

            <div class="summary-card orders">
                <div class="card-icon">
                    <i class="fas fa-box"></i>
                </div>
                <div class="card-content">
                    <div class="card-label">Total Orders</div>
                    <div class="card-value" id="totalOrders">0</div>
                    <div class="card-trend" id="ordersTrend"></div>
                </div>
            </div>

            <div class="summary-card cash">
                <div class="card-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="card-content">
                    <div class="card-label">Cash Payments</div>
                    <div class="card-value" id="cashRevenue">R0.00</div>
                    <div class="card-subtext" id="cashOrders">0 orders</div>
                </div>
            </div>

            <div class="summary-card card">
                <div class="card-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="card-content">
                    <div class="card-label">Card Payments</div>
                    <div class="card-value" id="cardRevenue">R0.00</div>
                    <div class="card-subtext" id="cardOrders">0 orders</div>
                </div>
            </div>

            <div class="summary-card avg">
                <div class="card-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="card-content">
                    <div class="card-label">Average Order Value</div>
                    <div class="card-value" id="avgOrderValue">R0.00</div>
                </div>
            </div>

            <div class="summary-card peak">
                <div class="card-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="card-content">
                    <div class="card-label">Best Day</div>
                    <div class="card-value" id="bestDay">-</div>
                    <div class="card-subtext" id="bestDayRevenue">R0.00</div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <!-- Daily Revenue Trend -->
            <div class="chart-card full-width">
                <h3><i class="fas fa-chart-area"></i> Daily Revenue Trend</h3>
                <canvas id="dailyRevenueChart"></canvas>
            </div>

            <!-- Payment Methods -->
            <div class="chart-card">
                <h3><i class="fas fa-chart-pie"></i> Payment Methods</h3>
                <canvas id="paymentChart"></canvas>
            </div>

            <!-- Category Performance -->
            <div class="chart-card">
                <h3><i class="fas fa-utensils"></i> Category Performance</h3>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- Top Performers -->
        <div class="performers-grid">
            <!-- Top Items -->
            <div class="performers-card">
                <h3><i class="fas fa-fire"></i> Top Selling Items</h3>
                <div class="performers-list" id="topItems">
                    <div class="no-data">No data available</div>
                </div>
            </div>

            <!-- Top Days -->
            <div class="performers-card">
                <h3><i class="fas fa-calendar-check"></i> Top Revenue Days</h3>
                <div class="performers-list" id="topDays">
                    <div class="no-data">No data available</div>
                </div>
            </div>
        </div>

        <!-- Comparison Table -->
        <div class="comparison-section">
            <h3><i class="fas fa-table"></i> Weekly Breakdown</h3>
            <div class="table-container">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Week</th>
                            <th>Orders</th>
                            <th>Revenue</th>
                            <th>Cash</th>
                            <th>Card</th>
                            <th>Avg Order</th>
                        </tr>
                    </thead>
                    <tbody id="weeklyTableBody">
                        <tr>
                            <td colspan="6" class="no-data">No data available</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let dailyRevenueChart, paymentChart, categoryChart;

        // Set current month as default
        const now = new Date();
        document.getElementById('monthInput').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

        // Load report on page load
        window.addEventListener('load', loadMonthlyReport);

        async function loadMonthlyReport() {
            const selectedMonth = document.getElementById('monthInput').value;
            
            if (!selectedMonth) {
                alert('Please select a month');
                return;
            }

            const [year, month] = selectedMonth.split('-');

            try {
                const response = await fetch(`/api/analytics/monthly-report?year=${year}&month=${month}`);
                const data = await response.json();

                updateSummaryCards(data);
                updateDailyRevenueChart(data.dailyRevenue || []);
                updatePaymentChart(data.paymentStats || []);
                updateCategoryChart(data.categoryStats || []);
                updateTopItems(data.topItems || []);
                updateTopDays(data.topDays || []);
                updateWeeklyTable(data.weeklyData || []);

            } catch (error) {
                console.error('Error loading monthly report:', error);
                alert('Failed to load report');
            }
        }

        function updateSummaryCards(data) {
            document.getElementById('totalRevenue').textContent = `R${(data.totalRevenue || 0).toFixed(2)}`;
            document.getElementById('totalOrders').textContent = data.totalOrders || 0;
            document.getElementById('avgOrderValue').textContent = `R${(data.avgOrderValue || 0).toFixed(2)}`;

            let cashRev = 0, cashCount = 0, cardRev = 0, cardCount = 0;
            
            (data.paymentStats || []).forEach(stat => {
                if (stat.payment_method === 'cash') {
                    cashRev = stat.total_revenue;
                    cashCount = stat.order_count;
                } else if (stat.payment_method === 'card') {
                    cardRev = stat.total_revenue;
                    cardCount = stat.order_count;
                }
            });

            document.getElementById('cashRevenue').textContent = `R${cashRev.toFixed(2)}`;
            document.getElementById('cashOrders').textContent = `${cashCount} orders`;
            document.getElementById('cardRevenue').textContent = `R${cardRev.toFixed(2)}`;
            document.getElementById('cardOrders').textContent = `${cardCount} orders`;

            if (data.bestDay) {
                const date = new Date(data.bestDay.date);
                document.getElementById('bestDay').textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                document.getElementById('bestDayRevenue').textContent = `R${data.bestDay.revenue.toFixed(2)}`;
            }
        }

        function updateDailyRevenueChart(dailyData) {
            const ctx = document.getElementById('dailyRevenueChart').getContext('2d');
            
            if (dailyRevenueChart) {
                dailyRevenueChart.destroy();
            }

            dailyRevenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyData.map(d => new Date(d.date).getDate()),
                    datasets: [{
                        label: 'Revenue (R)',
                        data: dailyData.map(d => d.revenue),
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updatePaymentChart(paymentStats) {
            const ctx = document.getElementById('paymentChart').getContext('2d');
            
            if (paymentChart) {
                paymentChart.destroy();
            }

            const cashData = paymentStats.find(s => s.payment_method === 'cash');
            const cardData = paymentStats.find(s => s.payment_method === 'card');

            paymentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cash', 'Card'],
                    datasets: [{
                        data: [
                            cashData ? cashData.total_revenue : 0,
                            cardData ? cardData.total_revenue : 0
                        ],
                        backgroundColor: ['#FF9800', '#9C27B0'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateCategoryChart(categoryStats) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (categoryChart) {
                categoryChart.destroy();
            }

            categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categoryStats.map(c => c.category),
                    datasets: [{
                        label: 'Revenue (R)',
                        data: categoryStats.map(c => c.total_sales),
                        backgroundColor: ['#FF6B35', '#4CAF50', '#2196F3'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTopItems(items) {
            const container = document.getElementById('topItems');
            
            if (items.length === 0) {
                container.innerHTML = '<div class="no-data">No data available</div>';
                return;
            }

            container.innerHTML = items.slice(0, 10).map((item, index) => `
                <div class="performer-item">
                    <div class="performer-rank">${index + 1}</div>
                    <div class="performer-info">
                        <div class="performer-name">${item.name}</div>
                        <div class="performer-stats">
                            <span><i class="fas fa-shopping-bag"></i> ${item.quantity} sold</span>
                            <span class="performer-revenue">R${item.revenue.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateTopDays(days) {
            const container = document.getElementById('topDays');
            
            if (days.length === 0) {
                container.innerHTML = '<div class="no-data">No data available</div>';
                return;
            }

            container.innerHTML = days.slice(0, 10).map((day, index) => `
                <div class="performer-item">
                    <div class="performer-rank">${index + 1}</div>
                    <div class="performer-info">
                        <div class="performer-name">${new Date(day.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                        <div class="performer-stats">
                            <span><i class="fas fa-shopping-cart"></i> ${day.orders} orders</span>
                            <span class="performer-revenue">R${day.revenue.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateWeeklyTable(weeklyData) {
            const tbody = document.getElementById('weeklyTableBody');
            
            if (weeklyData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No data available</td></tr>';
                return;
            }

            tbody.innerHTML = weeklyData.map(week => `
                <tr>
                    <td><strong>Week ${week.week}</strong></td>
                    <td>${week.orders}</td>
                    <td class="amount">R${week.revenue.toFixed(2)}</td>
                    <td>R${week.cash.toFixed(2)}</td>
                    <td>R${week.card.toFixed(2)}</td>
                    <td>R${week.avgOrder.toFixed(2)}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>